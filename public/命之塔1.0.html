<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å“¨å…µ / å‘å¯¼ ä¸–ç•Œè§‚æŠ½å–å™¨</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --bg2:#e9eaee;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(17,24,39,.12);
      --shadow: 0 10px 30px rgba(17,24,39,.08);
      --btn:#111827;
      --btnText:#ffffff;
      --btn2:#f3f4f6;
      --btn2Text:#111827;
      --primary: #0369a1;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans SC", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 20% 15%, rgba(0,0,0,.06), transparent 60%),
        radial-gradient(800px 450px at 85% 30%, rgba(0,0,0,.05), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{ width:min(1000px, 100%); display:grid; gap:16px; position: relative; }
    
    .header{
      padding:18px;
      border:1px solid var(--border);
      border-radius:16px;
      background: rgba(255,255,255,.78);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .title{ font-size:22px; font-weight:900; margin:0 0 8px 0; letter-spacing:.3px; }
    .sub{ margin:0; color:var(--muted); line-height:1.55; font-size:14px; }

    .card{
      border:1px solid var(--border);
      border-radius:16px;
      background: var(--card);
      padding:18px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      transition: box-shadow 0.3s ease, border-color 0.3s ease;
    }
    
    /* é”å®šçŠ¶æ€ç‰¹æ•ˆ */
    .card.is-locked {
      border-color: #dc2626;
      box-shadow: 0 0 0 1px #dc2626, 0 10px 30px rgba(220, 38, 38, 0.1);
    }
    .stamp {
      position: absolute;
      top: 30px;
      right: 30px;
      color: #dc2626;
      border: 4px solid #dc2626;
      padding: 6px 16px;
      font-size: 28px;
      font-weight: 900;
      border-radius: 8px;
      letter-spacing: 2px;
      transform: rotate(15deg);
      opacity: 0;
      pointer-events: none;
      z-index: 10;
    }
    .card.is-locked .stamp {
      animation: stampIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes stampIn {
      0% { transform: scale(3) rotate(25deg); opacity: 0; }
      100% { transform: scale(1) rotate(15deg); opacity: 0.85; }
    }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between; }

    button{
      border:1px solid rgba(17,24,39,.12);
      cursor:pointer;
      padding:12px 16px;
      border-radius:12px;
      font-weight:900;
      font-size:15px;
      transition: all .15s ease;
    }
    button:active{ transform: translateY(1px); }
    button:hover{ filter:brightness(0.95); }
    #drawBtn{
      background: var(--btn);
      color: var(--btnText);
      box-shadow: 0 10px 26px rgba(17,24,39,.14);
    }
    .smallbtn{
      background: var(--btn2);
      color: var(--btn2Text);
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid var(--border);
      background: rgba(17,24,39,.03);
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: rgba(17,24,39,.75);
      box-shadow:0 0 0 4px rgba(17,24,39,.08);
    }
    .card.is-locked .dot { background: #dc2626; box-shadow:0 0 0 4px rgba(220,38,38,.15); }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:12px;
    }
    .box-spirit { grid-column: span 2; }
    
    @media (max-width: 850px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .box-spirit { grid-column: span 2; }
    }
    @media (max-width: 500px){
      .grid{ grid-template-columns: 1fr; }
      .box-spirit { grid-column: span 1; }
    }

    .box{
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      background: rgba(17,24,39,.02);
      min-height:92px;
      display:flex;
      flex-direction:column;
    }
    .label{ font-size:12px; color:var(--muted); margin-bottom:8px; }
    .value{ font-size:18px; font-weight:950; letter-spacing:.2px; line-height:1.2; word-break:break-word; color:var(--text); }
    .hint{ margin-top:auto; padding-top:10px; color:var(--muted); font-size:12px; line-height:1.5; }
    
    .rank-val{ color: #047857; } 
    .gold{ color: #d97706; }
    .ability{ color: var(--primary); }
    .role-special{ color: #6b21a8; }
    .text-muted{ color: var(--muted); font-weight: normal; }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(17, 24, 39, 0.6);
      backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center;
      z-index: 999; padding: 20px;
      opacity: 0; transition: opacity 0.3s ease;
    }
    .modal-overlay.active { display: flex; opacity: 1; }
    .modal-content {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      width: 100%; max-width: 960px;
      max-height: 90vh; overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      transform: translateY(20px); transition: transform 0.3s ease;
    }
    .modal-content.small { max-width: 450px; text-align: center; }
    .modal-overlay.active .modal-content { transform: translateY(0); }
    .modal-header { text-align: center; margin-bottom: 20px; }
    .modal-title { font-size: 20px; font-weight: 900; margin: 0 0 8px 0; }
    .modal-sub { color: var(--muted); font-size: 14px; margin: 0; }
    
    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }
    .history-card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      display: flex; flex-direction: column; gap: 10px;
      background: rgba(17,24,39,.01);
      transition: transform 0.2s, border-color 0.2s;
    }
    .history-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      background: #fff;
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    .h-title { font-weight: 900; font-size: 15px; border-bottom: 1px dashed var(--border); padding-bottom: 8px; }
    .h-row { font-size: 14px; display: flex; justify-content: space-between; }
    .h-row .h-label { color: var(--muted); }
    .h-row .h-val { font-weight: bold; }
    .select-btn { margin-top: 8px; width: 100%; background: var(--btn2); color: var(--btn2Text); }
    .select-btn:hover { background: var(--btn); color: var(--btnText); }

    /* è¾“å…¥æ¡†æ ·å¼ */
    input[type="text"] {
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 16px;
      width: 100%;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      text-align: center;
    }
    input[type="text"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.15);
    }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1 class="title">å“¨å…µ / å‘å¯¼ ä¸–ç•Œè§‚æŠ½å–å™¨</h1>
      <p class="sub">
        ç‚¹å‡»æŠ½å–ï¼šç”Ÿæˆ <b>èº«ä»½</b>ã€<b>ç­‰çº§(ç²¾ç¥/è‚‰ä½“)</b>ã€<b>åˆå§‹é‡‘å¸</b>ã€<b>èƒ½åŠ›åå¥½</b> ä¸ <b>ç²¾ç¥ä½“</b>ã€‚<br>
        <i>* æ»¡ 10 æ¬¡åéœ€ä»è®°å½•ä¸­é€‰æ‹© 1 ä¸ªï¼Œè‹¥ä¸ºå“¨/å‘å¯å†³å®šæ˜¯å¦ä¿ç•™ç²¾ç¥ä½“ï¼Œç¡®è®¤åæ°¸ä¹…é”å®šã€‚<br>
        * è®¾å®šï¼šæ™®é€šäººæ— ç²¾ç¥ç­‰çº§ï¼Œé¬¼é­‚æ— è‚‰ä½“å¼ºåº¦ï¼Œä¸”ä¸¤è€…å‡æ— ç²¾ç¥ä½“ã€‚</i>
      </p>
    </div>

    <div class="card" id="mainCard">
      <div class="stamp">FINAL LOCKED</div>
      <div class="row">
        <div class="pill"><span class="dot"></span><span id="status">å°±ç»ª (0/10)</span></div>
        <div class="row" style="justify-content:flex-end; flex:1;">
          <button id="drawBtn">æŠ½å– (å‰©ä½™10æ¬¡)</button>
          <button id="copyBtn" class="smallbtn" title="å¤åˆ¶å½“å‰ç»“æœ">å¤åˆ¶ç»“æœ</button>
        </div>
      </div>

      <div class="grid">
        <div class="box">
          <div class="label">1) èº«ä»½</div>
          <div class="value" id="roleVal">â€”</div>
          <div class="hint">å“¨/å‘å„40%ï¼Œäºº/é¬¼å„10%</div>
        </div>
        <div class="box">
          <div class="label">2) ç²¾ç¥ç­‰çº§</div>
          <div class="value rank-val" id="mentalRankVal">â€”</div>
          <div class="hint">D-SSSï¼›S+åˆè®¡2%</div>
        </div>
        <div class="box">
          <div class="label">3) è‚‰ä½“å¼ºåº¦</div>
          <div class="value rank-val" id="physicalRankVal">â€”</div>
          <div class="hint">D-SSSï¼›S+åˆè®¡2%</div>
        </div>
        <div class="box">
          <div class="label">4) åˆå§‹é‡‘å¸</div>
          <div class="value gold" id="goldVal">â€”</div>
          <div class="hint">100-10000 (â‰¥8kå 10%)</div>
        </div>
        <div class="box">
          <div class="label">5) èƒ½åŠ›åå¥½</div>
          <div class="value ability" id="abilityVal">â€”</div>
          <div class="hint">å…«å¤§æ´¾ç³»éšæœº</div>
        </div>
        <div class="box box-spirit">
          <div class="label">6) ç²¾ç¥ä½“</div>
          <div class="value" id="spiritVal">â€”</div>
          <div class="hint" id="spiritHint">åŠ¨ç‰©ä¸ºä¸»ï¼Œå°‘é‡æ¤ç‰©</div>
        </div>
        <div class="box">
          <div class="label">æŠ½å–è¿›åº¦</div>
          <div class="value" id="countVal">0 / 10</div>
          <div class="hint">æ»¡10æ¬¡åè¿›å…¥æœ€ç»ˆæŠ‰æ‹©</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 10é€‰1 æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">å‘½è¿æŠ‰æ‹© (10é€‰1)</h2>
        <p class="modal-sub">ä½ å·²å®Œæˆ 10 æ¬¡æŠ½å–ï¼Œè¯·ä»ä¸‹æ–¹è®°å½•ä¸­é€‰æ‹©ä¸€ä¸ªä½œä¸ºä½ çš„åŸºç¡€å±æ€§ã€‚</p>
      </div>
      <div class="history-grid" id="historyGrid">
        <!-- å¡ç‰‡ç”±JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- ç²¾ç¥ä½“ç¡®è®¤ æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="spiritModal">
    <div class="modal-content small">
      
      <!-- è§†å›¾1ï¼šè¯¢é—®æ˜¯å¦å–œæ¬¢ -->
      <div id="spiritQuestionView">
        <h2 class="modal-title" style="margin-bottom: 16px;">ç²¾ç¥ä½“ç¡®è®¤</h2>
        <p style="font-size: 16px; margin-bottom: 24px;">
          æ‚¨æ˜¯å¦å–œæ¬¢æ‚¨ç°åœ¨çš„ç²¾ç¥ä½“ï¼š<br>
          <strong id="currentSpiritName" style="color: var(--primary); font-size: 22px; display: inline-block; margin-top: 8px;">â€”</strong> ï¼Ÿ
        </p>
        <div class="row" style="justify-content: center; gap: 16px;">
          <button id="btnLike" style="background: #047857; color: #fff; border: none; flex: 1;">æ˜¯ï¼Œæˆ‘å¾ˆå–œæ¬¢</button>
          <button id="btnDislike" style="background: #dc2626; color: #fff; border: none; flex: 1;">å¦ï¼Œæˆ‘ä¸å–œæ¬¢</button>
        </div>
      </div>

      <!-- è§†å›¾2ï¼šç¦»å¼€å¹¶é‡æ–°è¾“å…¥ -->
      <div id="spiritInputView" style="display: none;">
        <h2 class="modal-title" style="color: #dc2626; margin-bottom: 12px;">æ‚¨çš„ç²¾ç¥ä½“ç¦»å¼€äº† ğŸ˜­</h2>
        <p class="modal-sub" style="margin-bottom: 20px;">è¯·é‡æ–°å‘¼å”¤ä¸€ä¸ªå±äºæ‚¨çš„ç²¾ç¥ä½“ï¼š</p>
        <input type="text" id="customSpiritInput" placeholder="è¾“å…¥æ–°çš„ç²¾ç¥ä½“åç§°..." autocomplete="off" />
        <button id="btnConfirmSpirit" style="width: 100%; margin-top: 20px;">ç¡®è®¤å‘¼å”¤</button>
      </div>

    </div>
  </div>

<script>
  // æ ¸å¿ƒçŠ¶æ€
  const MAX_DRAWS = 10;
  let drawCount = 0;
  let historyData = [];
  let isLocked = false;
  let finalData = null;

  // åŸºç¡€æ•°æ®æ± 
  const ROLE_WEIGHTS = [
    { name: "å“¨å…µ", w: 40 },
    { name: "å‘å¯¼", w: 40 },
    { name: "æ™®é€šäºº", w: 10 },
    { name: "é¬¼é­‚", w: 10 }
  ];
  const RANK_WEIGHTS = [
    { name: "D",   w: 24.5 },
    { name: "C",   w: 24.5 },
    { name: "B",   w: 24.5 },
    { name: "A",   w: 24.5 },
    { name: "S",   w: 1.2  },
    { name: "SS",  w: 0.6  },
    { name: "SSS", w: 0.2  },
  ];
  const ABILITIES = ["ç‰©ç†ç³»", "å…ƒç´ ç³»", "ç²¾ç¥ç³»", "æ„ŸçŸ¥ç³»", "ä¿¡æ¯ç³»", "æ²»ç–—ç³»", "å¼ºåŒ–ç³»", "ç‚¼é‡‘ç³»"];
  const PLANT_RATE = 0.12;
  const PLANT_SPIRITS = ["ç«ç‘°","èŒ‰è‰","æ €å­èŠ±","è–°è¡£è‰","å‘æ—¥è‘µ","é›èŠ","éƒé‡‘é¦™","æ¨±èŠ±","è·èŠ±","æ¡‚èŠ±","ç‰µç‰›èŠ±","ç´«è—¤","å¸¸æ˜¥è—¤","è‘¡è„è—¤","å‡Œéœ„èŠ±","è–„è·","è¿·è¿­é¦™","é¼ å°¾è‰","é“ƒå…°","å±±èŒ¶èŠ±","ç™¾åˆ","é¸¢å°¾","ç»£çƒèŠ±","ä¸é¦™","å¤œæ¥é¦™","è”·è–‡","æœ¨æ§¿","èŠè¯","ç‰¡ä¸¹","é‡‘é“¶èŠ±"];
  const ANIMAL_SPIRITS = ["ç‹¼","ç°ç‹¼","åŒ—æç‹¼","èµ¤ç‹","åŒ—æç‹","è±º","é¬£ç‹—","è™","ä¸œåŒ—è™","è±¹","é›ªè±¹","ç¾æ´²è±¹","çŒè±¹","çŒçŒ","å…”ç‹²","æ£•ç†Š","é»‘ç†Š","åŒ—æç†Š","æµ£ç†Š","ç¾","æ°´ç­","è²‚","é»„é¼¬","é‡çŒª","æ¢…èŠ±é¹¿","éº‹é¹¿","é©¯é¹¿","ç¾šç¾Š","ç¾Šé©¼","ç‰¦ç‰›","é‡ç‰›","å¤§è±¡","éæ´²è±¡","æ²³é©¬","çŠ€ç‰›","é»‘çŒ©çŒ©","å¤§çŒ©çŒ©","çŒ•çŒ´","ç‹’ç‹’","ç‹çŒ´","ç™½å¤´æµ·é›•","é‡‘é›•","æ¸¸éš¼","è‹é¹°","çŒ«å¤´é¹°","é›ªé¸®","ä¹Œé¸¦","æ¸¡é¸¦","å–œé¹Š","å¤©é¹…","ç™½é¹­","ä¸¹é¡¶é¹¤","ç«çƒˆé¸Ÿ","å­”é›€","èœ‚é¸Ÿ","å•„æœ¨é¸Ÿ","ä¿¡å¤©ç¿","ä¼é¹…","æµ·è±š","ç“¶é¼»æµ·è±š","è™é²¸","åº§å¤´é²¸","è“é²¸","æŠ¹é¦™é²¸","æµ·ç‹®","æµ·è±¹","æµ·è±¡","å¤§ç™½é²¨","é”¤å¤´é²¨","è é²¼","é³é±¼","æ——é±¼","é‡‘æªé±¼","å°ä¸‘é±¼","æµ·é©¬","ç§‘è«å¤šå·¨èœ¥","å˜è‰²é¾™","ç»¿é¬£èœ¥","çœ¼é•œè›‡","èŸ’è›‡","å“å°¾è›‡","æµ·é¾Ÿ","é™†é¾Ÿ","é³„é±¼","çŸ­å»é³„","æ ‘è›™","ç®­æ¯’è›™","è¾èˆ","ç«èœ¥èœ´","ç« é±¼","ä¹Œè´¼","é±¿é±¼","æ°´æ¯","æµ·æ˜Ÿ","æµ·èƒ†","è³è‚","ç«¹èŠ‚è™«","ç‹¬è§’ä»™","é”¹å½¢è™«","èœœèœ‚","é»„èœ‚","å¸ç‹è¶","å‡¤è¶","èœ»èœ“","ç‹¼è››","èå­","èƒèŸ¹","é¾™è™¾"];

  // å·¥å…·å‡½æ•°
  function weightedPick(items) {
    const total = items.reduce((s, x) => s + x.w, 0);
    let r = Math.random() * total;
    for (const it of items) { r -= it.w; if (r <= 0) return it.name; }
    return items[items.length - 1].name;
  }
  const pickFrom = (arr) => arr[Math.floor(Math.random() * arr.length)];
  
  function generateData() {
    const role = weightedPick(ROLE_WEIGHTS);
    
    let mentalRank = "â€”";
    let physicalRank = "â€”";
    let spirit = { name: "æ— ", type: "æ— " }; // é»˜è®¤æ— ç²¾ç¥ä½“
    
    if (role === "å“¨å…µ" || role === "å‘å¯¼") {
      mentalRank = weightedPick(RANK_WEIGHTS);
      physicalRank = weightedPick(RANK_WEIGHTS);
      
      const isPlant = Math.random() < PLANT_RATE;
      spirit = isPlant 
        ? { name: pickFrom(PLANT_SPIRITS), type: "æ¤ç‰©" } 
        : { name: pickFrom(ANIMAL_SPIRITS), type: "åŠ¨ç‰©" };
    } else if (role === "æ™®é€šäºº") {
      mentalRank = "æ— "; 
      physicalRank = weightedPick(RANK_WEIGHTS);
      // ç²¾ç¥ä½“ä¿æŒä¸º "æ— "
    } else if (role === "é¬¼é­‚") {
      mentalRank = weightedPick(RANK_WEIGHTS);
      physicalRank = "æ— "; 
      // ç²¾ç¥ä½“ä¿æŒä¸º "æ— "
    }

    let gold = Math.random() < 0.10 
      ? Math.floor(Math.random() * (10000 - 8000 + 1)) + 8000 
      : Math.floor(Math.random() * (7999 - 100 + 1)) + 100;

    return {
      role: role,
      mentalRank: mentalRank,
      physicalRank: physicalRank,
      gold: gold,
      ability: pickFrom(ABILITIES),
      spirit: spirit
    };
  }

  // DOM å…ƒç´ 
  const elRole = document.getElementById("roleVal");
  const elMentalRank = document.getElementById("mentalRankVal");
  const elPhysicalRank = document.getElementById("physicalRankVal");
  const elGold = document.getElementById("goldVal");
  const elAbility = document.getElementById("abilityVal");
  const elSpirit = document.getElementById("spiritVal");
  const elSpiritHint = document.getElementById("spiritHint");
  const elStatus = document.getElementById("status");
  const elCount = document.getElementById("countVal");
  
  const drawBtn = document.getElementById("drawBtn");
  const copyBtn = document.getElementById("copyBtn");
  const mainCard = document.getElementById("mainCard");
  
  const modalOverlay = document.getElementById("modalOverlay");
  const historyGrid = document.getElementById("historyGrid");

  const spiritModal = document.getElementById("spiritModal");
  const spiritQuestionView = document.getElementById("spiritQuestionView");
  const spiritInputView = document.getElementById("spiritInputView");
  const currentSpiritName = document.getElementById("currentSpiritName");
  const customSpiritInput = document.getElementById("customSpiritInput");

  // æ›´æ–°ä¸»ç•Œé¢UI
  function updateUI(data) {
    elRole.textContent = data.role;
    if(data.role === "æ™®é€šäºº" || data.role === "é¬¼é­‚") elRole.classList.add("role-special");
    else elRole.classList.remove("role-special");

    elMentalRank.textContent = data.mentalRank;
    elMentalRank.className = data.mentalRank === "æ— " ? "value text-muted" : "value rank-val";
    
    elPhysicalRank.textContent = data.physicalRank;
    elPhysicalRank.className = data.physicalRank === "æ— " ? "value text-muted" : "value rank-val";
    
    elGold.textContent = data.gold;
    elAbility.textContent = data.ability;
    
    // ç²¾ç¥ä½“æ˜¾ç¤ºå¤„ç†
    elSpirit.textContent = data.spirit.name;
    elSpirit.className = data.spirit.name === "æ— " ? "value text-muted" : "value";
    elSpiritHint.textContent = data.spirit.type === "æ— " ? "æ™®é€šäºº/é¬¼é­‚æ— ç²¾ç¥ä½“" : `ç±»å‹ï¼š${data.spirit.type}`;
  }

  function setStatus(text) { elStatus.textContent = text; }

  // æ¸²æŸ“æ¨¡æ€æ¡†å†å²è®°å½•
  function renderHistory() {
    historyGrid.innerHTML = "";
    historyData.forEach((data, index) => {
      const card = document.createElement("div");
      card.className = "history-card";
      
      const roleClass = (data.role === "æ™®é€šäºº" || data.role === "é¬¼é­‚") ? "role-special" : "";
      const mentalHtml = data.mentalRank === "æ— " ? `<span class="text-muted">æ— </span>` : `<span class="rank-val">${data.mentalRank}</span>`;
      const physicalHtml = data.physicalRank === "æ— " ? `<span class="text-muted">æ— </span>` : `<span class="rank-val">${data.physicalRank}</span>`;
      const spiritHtml = data.spirit.name === "æ— " ? `<span class="text-muted">æ— </span>` : data.spirit.name;

      card.innerHTML = `
        <div class="h-title">ç¬¬ ${index + 1} æ¬¡æŠ½å–</div>
        <div class="h-row"><span class="h-label">èº«ä»½</span><span class="h-val ${roleClass}">${data.role}</span></div>
        <div class="h-row"><span class="h-label">ç²¾ç¥/è‚‰ä½“</span><span class="h-val">${mentalHtml} / ${physicalHtml}</span></div>
        <div class="h-row"><span class="h-label">é‡‘å¸</span><span class="h-val gold">${data.gold}</span></div>
        <div class="h-row"><span class="h-label">èƒ½åŠ›</span><span class="h-val ability">${data.ability}</span></div>
        <div class="h-row"><span class="h-label">ç²¾ç¥ä½“</span><span class="h-val">${spiritHtml}</span></div>
        <button class="select-btn" onclick="selectFinal(${index})">é€‰æ‹©æ­¤é¡¹</button>
      `;
      historyGrid.appendChild(card);
    });
  }

  // ç¬¬ä¸€æ­¥ï¼šåœ¨10é€‰1ä¸­é€‰æ‹©äº†æŸä¸€é¡¹
  window.selectFinal = function(index) {
    // æ·±æ‹·è´ä¸€ä¸‹ï¼Œä»¥å…ä¿®æ”¹å½±å“åŸå†å²è®°å½•
    finalData = JSON.parse(JSON.stringify(historyData[index])); 
    
    // éšè— 10é€‰1 æ¨¡æ€æ¡†
    modalOverlay.classList.remove("active");
    
    // å¦‚æœæ˜¯æ™®é€šäººæˆ–é¬¼é­‚ï¼Œæ²¡æœ‰ç²¾ç¥ä½“ï¼Œç›´æ¥è·³è¿‡è¯¢é—®è¿›å…¥æœ€ç»ˆé”å®š
    if (finalData.role === "æ™®é€šäºº" || finalData.role === "é¬¼é­‚") {
      executeFinalLock();
    } else {
      // å‡†å¤‡å¹¶å¼¹å‡ºç²¾ç¥ä½“ç¡®è®¤æ¨¡æ€æ¡†
      currentSpiritName.textContent = finalData.spirit.name;
      spiritQuestionView.style.display = "block";
      spiritInputView.style.display = "none";
      customSpiritInput.value = "";
      
      setTimeout(() => {
        spiritModal.classList.add("active");
      }, 300);
    }
  };

  // ç¬¬äºŒæ­¥ï¼šå–œæ¬¢ç²¾ç¥ä½“ï¼Œç›´æ¥é”å®š
  document.getElementById("btnLike").addEventListener("click", () => {
    spiritModal.classList.remove("active");
    executeFinalLock();
  });

  // ç¬¬ä¸‰æ­¥ï¼šä¸å–œæ¬¢ç²¾ç¥ä½“ï¼Œåˆ‡æ¢åˆ°è¾“å…¥è§†å›¾
  document.getElementById("btnDislike").addEventListener("click", () => {
    spiritQuestionView.style.display = "none";
    spiritInputView.style.display = "block";
    customSpiritInput.focus();
  });

  // ç¬¬å››æ­¥ï¼šè¾“å…¥æ–°ç²¾ç¥ä½“å¹¶ç¡®è®¤
  document.getElementById("btnConfirmSpirit").addEventListener("click", () => {
    const newVal = customSpiritInput.value.trim();
    if (!newVal) {
      alert("ç²¾ç¥ä½“åç§°ä¸èƒ½ä¸ºç©ºå“¦ï¼");
      return;
    }
    
    // æ›´æ–°ç²¾ç¥ä½“æ•°æ®
    finalData.spirit.name = newVal;
    finalData.spirit.type = "è‡ªå®šä¹‰";
    
    spiritModal.classList.remove("active");
    executeFinalLock();
  });

  // æ‰§è¡Œæœ€ç»ˆé”å®šå¹¶å±•ç¤ºä¸»é¢æ¿ï¼ˆç¡®å®šé¢æ¿ï¼‰
  function executeFinalLock() {
    isLocked = true;
    updateUI(finalData);
    
    mainCard.classList.add("is-locked");
    drawBtn.style.display = "none";
    
    elCount.textContent = `æœ€ç»ˆé”å®š`;
    setStatus("æ•°æ®å·²æ°¸ä¹…é”å®š");
  }

  // æŠ½å–æŒ‰é’®é€»è¾‘
  function drawOnce() {
    if (isLocked) return;
    
    if (drawCount >= MAX_DRAWS) {
      modalOverlay.classList.add("active");
      return;
    }

    const data = generateData();
    historyData.push(data);
    drawCount++;
    
    updateUI(data);
    elCount.textContent = `${drawCount} / ${MAX_DRAWS}`;
    drawBtn.textContent = `æŠ½å– (å‰©ä½™${MAX_DRAWS - drawCount}æ¬¡)`;
    setStatus(`æŠ½å–ä¸­... (${drawCount}/${MAX_DRAWS})`);

    // è¾¾åˆ°10æ¬¡
    if (drawCount === MAX_DRAWS) {
      drawBtn.textContent = "æ‰“å¼€æŠ‰æ‹©é¢æ¿";
      setStatus("è¯·é€‰æ‹©åŸºç¡€å±æ€§");
      
      setTimeout(() => {
        renderHistory();
        modalOverlay.classList.add("active");
      }, 400);
    }
  }

  // å¤åˆ¶é€»è¾‘
  async function copyResult() {
    if (drawCount === 0) {
      setStatus("è¯·å…ˆæŠ½å–å†å¤åˆ¶ï¼");
      return;
    }
    
    const prefix = isLocked ? "ã€å“¨å…µ/å‘å¯¼ æœ€ç»ˆé”å®šå±æ€§ã€‘" : "ã€å“¨å…µ/å‘å¯¼ æš‚å­˜å±æ€§ã€‘";
    const text =
`${prefix}
èº«ä»½ï¼š${elRole.textContent}
ç­‰çº§ï¼šç²¾ç¥ ${elMentalRank.textContent} / è‚‰ä½“ ${elPhysicalRank.textContent}
åˆå§‹é‡‘å¸ï¼š${elGold.textContent}
èƒ½åŠ›åå¥½ï¼š${elAbility.textContent}
ç²¾ç¥ä½“ï¼š${elSpirit.textContent}`;

    try {
      await navigator.clipboard.writeText(text);
      setStatus(isLocked ? "å·²å¤åˆ¶æœ€ç»ˆå±æ€§" : "å·²å¤åˆ¶æš‚å­˜å±æ€§");
    } catch {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      setStatus("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
    }
  }

  drawBtn.addEventListener("click", drawOnce);
  copyBtn.addEventListener("click", copyResult);
</script>
</body>
</html>
